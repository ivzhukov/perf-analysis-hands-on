"use strict";(self.webpackChunkperf_analysis=self.webpackChunkperf_analysis||[]).push([[8772],{7892:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>c,contentTitle:()=>i,default:()=>p,frontMatter:()=>o,metadata:()=>a,toc:()=>l});var t=s(4848),r=s(8453);const o={sidebar_position:2},i="Instrumentation",a={id:"instrumentation",title:"Instrumentation",description:"As a next step we are going to instrument our application, i.e. insert additional code into our program to collect performance data during its execution. Instrumentation can be done either manually by the programmer or automatically by tools like Score-P. The data collected includes information about user function calls, communication events, synchronization events, and more.",source:"@site/docs/instrumentation.md",sourceDirName:".",slug:"/instrumentation",permalink:"/perf-analysis-hands-on/docs/instrumentation",draft:!1,unlisted:!1,tags:[],version:"current",sidebarPosition:2,frontMatter:{sidebar_position:2},sidebar:"tutorialSidebar",previous:{title:"Baseline measurement",permalink:"/perf-analysis-hands-on/docs/baseline"},next:{title:"Filtering",permalink:"/perf-analysis-hands-on/docs/filtering"}},c={},l=[];function d(e){const n={a:"a",admonition:"admonition",code:"code",h1:"h1",p:"p",pre:"pre",...(0,r.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.h1,{id:"instrumentation",children:"Instrumentation"}),"\n",(0,t.jsx)(n.p,{children:"As a next step we are going to instrument our application, i.e. insert additional code into our program to collect performance data during its execution. Instrumentation can be done either manually by the programmer or automatically by tools like Score-P. The data collected includes information about user function calls, communication events, synchronization events, and more."}),"\n",(0,t.jsx)(n.p,{children:"Score-P can automatically instrument the code by using e.g. compiler wrappers. This eliminates the need for manual modification of the source code and makes the process easier and less error-prone."}),"\n",(0,t.jsx)(n.p,{children:"To use Score-P, we first need to make sure that all required software is available:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"$ # Reload modules if needed\n$ module load intel intel-mpi/2019-intel nano\n$ # Load additional software being used in the following steps\n$ module use /lrz/sys/courses/vihps/2024/modulefiles/\n$ module load scorep/8.4-intel-intelmpi scalasca/2.6.1-intel-intelmpi\n"})}),"\n",(0,t.jsx)(n.p,{children:"We loaded Scalasca trace tools at this stage as well to use convenience commands that allow to control execution measurement collection and analysis, and analysis report postprocessing. This is not necessary but highly recommended step to do."}),"\n",(0,t.jsx)(n.p,{children:"Go to our work directory"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"$ cd $HOME/tw45/NPB3.3-MZ-MPI\n"})}),"\n",(0,t.jsxs)(n.p,{children:["Edit ",(0,t.jsx)(n.code,{children:"config/make.def"})," to adjust build (see highlighted lines)"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",metastring:"showLineNumbers",children:'#---------------------------------------------------------------------------\n#\n#                SITE- AND/OR PLATFORM-SPECIFIC DEFINITIONS.\n#\n#---------------------------------------------------------------------------\n\n#---------------------------------------------------------------------------\n# Configured for generic MPI with GCC compiler\n#---------------------------------------------------------------------------\n#OPENMP = -fopenmp      # GCC compiler\nOPENMP  = -qopenmp      # Intel compiler\n\n#---------------------------------------------------------------------------\n# Parallel Fortran:\n#\n# The following must be defined:\n#\n# MPIF77     - Fortran compiler\n# FFLAGS     - Fortran compilation arguments\n# F_INC      - any -I arguments required for compiling MPI/Fortran\n# FLINK      - Fortran linker\n# FLINKFLAGS - Fortran linker arguments\n# F_LIB      - any -L and -l arguments required for linking MPI/Fortran\n#\n# compilations are done with $(MPIF77) $(F_INC) $(FFLAGS) or\n#                            $(MPIF77) $(FFLAGS)\n# linking is done with       $(FLINK) $(F_LIB) $(FLINKFLAGS)\n#---------------------------------------------------------------------------\n\n#---------------------------------------------------------------------------\n# The fortran compiler used for hybrid MPI programs\n#---------------------------------------------------------------------------\n# highlight-next-line\nMPIF77 = mpif77\n\n# Alternative variants to perform instrumentation\n#MPIF77 = psc_instrument -t user,mpi,omp -s ${PROGRAM}.sir  mpif77\n#MPIF77 = scalasca -instrument  mpif77\n#MPIF77 = tau_f90.sh\n#MPIF77 = vtf77 -vt:hyb -vt:f77  mpif77\n# highlight-next-line\nMPIF77 = scorep --user  mpif77\n\n# PREP is a generic macro for instrumentation preparation\n#MPIF77 = $(PREP)  mpif77\n\n# This links MPI fortran programs; usually the same as ${F77}\nFLINK   = $(MPIF77)\n\n#---------------------------------------------------------------------------\n# Global *compile time* flags for Fortran programs\n#---------------------------------------------------------------------------\nFFLAGS  = -O3 -g $(OPENMP)\n\n#---------------------------------------------------------------------------\n# These macros are passed to the compiler\n#---------------------------------------------------------------------------\nF_INC =\n\n#---------------------------------------------------------------------------\n# These macros are passed to the linker\n#---------------------------------------------------------------------------\nF_LIB  =\n\n#---------------------------------------------------------------------------\n# Global *link time* flags. Flags for increasing maximum executable\n# size usually go here.\n#---------------------------------------------------------------------------\nFLINKFLAGS = $(FFLAGS)\n\n\n#---------------------------------------------------------------------------\n# Utilities C:\n#\n                                                                                                                                    41,0-1        58%\n# Other allowed values are "randi8_safe", "randdp" and "randdpvec"\n#---------------------------------------------------------------------------\nRAND   = randi8\n# The following is highly reliable but may be slow:\n# RAND   = randdp\n'})}),"\n",(0,t.jsxs)(n.admonition,{type:"info",children:[(0,t.jsxs)(n.p,{children:["In ",(0,t.jsx)(n.code,{children:"config/make.def"})," we can set necessary flags for appropriate compilation, e.g. enabling OpenMP, optimisation flags, etc."]}),(0,t.jsxs)(n.p,{children:["To enable instrumentation we added special wrapper ",(0,t.jsx)(n.code,{children:"scorep"})," before actual compiler wrapper, e.g. ",(0,t.jsx)(n.code,{children:"mpif77"}),". This will insert additional flags during compilation and add required libraries during linking phase."]})]}),"\n",(0,t.jsx)(n.admonition,{type:"warning",children:(0,t.jsxs)(n.p,{children:["The ",(0,t.jsx)(n.code,{children:"scorep"})," instrumenter must be used with the link command to ensure that all required Score-P measurement libraries are linked with the executable. However, not all object files need to be instrumented, thereby avoiding measurements and data collection for routines and OpenMP constructs defined in those files. Instrumenting files defining OpenMP parallel regions is essential, as Score-P has to track the creation of new threads."]})}),"\n",(0,t.jsx)(n.p,{children:"Lets return to our root directory and clean-up:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"$ cd $HOME/tw45/NPB3.3-MZ-MPI/\n$ make clean\n"})}),"\n",(0,t.jsx)(n.p,{children:"Next, we build the instrumented version of BT-MZ:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"$ make bt-mz CLASS=C NPROCS=28\n   ===========================================\n   =      NAS PARALLEL BENCHMARKS 3.3        =\n   =      MPI+OpenMP Multi-Zone Versions     =\n   =      F77                                =\n   ===========================================\n\ncd BT-MZ; make CLASS=C NPROCS=28 VERSION=\nmake[1]: Entering directory '/dss/dsshome1/0C/hpckurs11/tw45/NPB3.3-MZ-MPI/BT-MZ'\nmake[2]: Entering directory '/dss/dsshome1/0C/hpckurs11/tw45/NPB3.3-MZ-MPI/sys'\ncc  -o setparams setparams.c -lm\nmake[2]: Leaving directory '/dss/dsshome1/0C/hpckurs11/tw45/NPB3.3-MZ-MPI/sys'\n../sys/setparams bt-mz 28 C\nmake[2]: Entering directory '/dss/dsshome1/0C/hpckurs11/tw45/NPB3.3-MZ-MPI/BT-MZ'\nscorep --user  mpif77 -c  -O3 -g -qopenmp\t bt.f\nscorep --user  mpif77 -c  -O3 -g -qopenmp\t initialize.f\nscorep --user  mpif77 -c  -O3 -g -qopenmp\t exact_solution.f\nscorep --user  mpif77 -c  -O3 -g -qopenmp\t exact_rhs.f\nscorep --user  mpif77 -c  -O3 -g -qopenmp\t set_constants.f\nscorep --user  mpif77 -c  -O3 -g -qopenmp\t adi.f\nscorep --user  mpif77 -c  -O3 -g -qopenmp\t rhs.f\nscorep --user  mpif77 -c  -O3 -g -qopenmp\t zone_setup.f\nscorep --user  mpif77 -c  -O3 -g -qopenmp\t x_solve.f\nscorep --user  mpif77 -c  -O3 -g -qopenmp\t y_solve.f\nscorep --user  mpif77 -c  -O3 -g -qopenmp\t exch_qbc.f\nscorep --user  mpif77 -c  -O3 -g -qopenmp\t solve_subs.f\nscorep --user  mpif77 -c  -O3 -g -qopenmp\t z_solve.f\nscorep --user  mpif77 -c  -O3 -g -qopenmp\t add.f\nscorep --user  mpif77 -c  -O3 -g -qopenmp\t error.f\nscorep --user  mpif77 -c  -O3 -g -qopenmp\t verify.f\nscorep --user  mpif77 -c  -O3 -g -qopenmp\t mpi_setup.f\ncd ../common; scorep --user  mpif77 -c  -O3 -g -qopenmp\t print_results.f\ncd ../common; scorep --user  mpif77 -c  -O3 -g -qopenmp\t timers.f\nscorep --user  mpif77 -O3 -g -qopenmp\t -o ../bin.scorep/bt-mz_C.28 bt.o  initialize.o exact_solution.o exact_rhs.o set_constants.o adi.o  rhs.o zone_setup.o x_solve.o y_solve.o  exch_qbc.o solve_subs.o z_solve.o add.o error.o verify.o mpi_setup.o ../common/print_results.o ../common/timers.o \nmake[2]: Leaving directory '/dss/dsshome1/0C/hpckurs11/tw45/NPB3.3-MZ-MPI/BT-MZ'\nBuilt executable ../bin.scorep/bt-mz_C.28\nmake[1]: Leaving directory '/dss/dsshome1/0C/hpckurs11/tw45/NPB3.3-MZ-MPI/BT-MZ'\n"})}),"\n",(0,t.jsxs)(n.p,{children:["As you might noticed now ",(0,t.jsx)(n.code,{children:"scorep"})," stands before each compilation and linking command. This time executable was created in ",(0,t.jsx)(n.code,{children:"bin.scorep"})," directory that allow us not to mess up with our baseline experiments."]}),"\n",(0,t.jsx)(n.p,{children:"Let's go to the directory where our new executable lies and copy batch script"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"$ cd bin.scorep\n$ cp ../jobscript/coolmuc2/scorep.sbatch .\n"})}),"\n",(0,t.jsxs)(n.p,{children:["Let's examine what ",(0,t.jsx)(n.code,{children:"scorep.sbatch"})," does by executing ",(0,t.jsx)(n.code,{children:"nano scorep.batch"})]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",metastring:"showLineNumbers",children:"#!/bin/bash\n#SBATCH -o bt-mz.%j.out\n#SBATCH -e bt-mz.%j.err\n#SBATCH -J bt-mz\n#SBATCH --clusters=cm2_tiny\n#SBATCH --partition=cm2_tiny\n#SBATCH --reservation=hhps1s24\n#SBATCH --nodes=2\n#SBATCH --ntasks=28\n#SBATCH --ntasks-per-node=14\n#SBATCH --get-user-env\n#SBATCH --time=00:05:00\n\nmodule use /lrz/sys/courses/vihps/2024/modulefiles/\nmodule load scorep/8.4-intel-intelmpi\nexport OMP_NUM_THREADS=4\n\n# Score-P measurement configuration\n# highlight-next-line\nexport SCOREP_EXPERIMENT_DIRECTORY=scorep_bt-mz_sum\n#export SCOREP_FILTERING_FILE=../config/scorep.filt\n\n# Benchmark configuration (disable load balancing with threads)\nexport NPB_MZ_BLOAD=0\nPROCS=28\nCLASS=C\n\n# Run the application\nmpiexec -n $SLURM_NTASKS ./bt-mz_$CLASS.$PROCS\n"})}),"\n",(0,t.jsx)(n.p,{children:"In highlighted line we set name of the directory where we store measurements. This is not required, but helps identifying the measurement later on."}),"\n",(0,t.jsx)(n.admonition,{type:"info",children:(0,t.jsxs)(n.p,{children:["Score-P measurements are configured via environment variables with the prefix ",(0,t.jsx)(n.code,{children:"SCOREP_"}),". The full list of available variables and their description can be found by executing the following command ",(0,t.jsx)(n.code,{children:"scorep-info config-vars --full"})]})}),"\n",(0,t.jsx)(n.p,{children:"Now we are ready to submit our batch script:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"sbatch scorep.sbatch\n"})}),"\n",(0,t.jsx)(n.p,{children:"Once your job complete check what is new in the execution directory"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"$ ls -l\nbt-mz_C.28\nbt-mz.657477.out\nbt-mz.657477.err\nscorep_bt-mz_sum\nscorep.sbatch\n"})}),"\n",(0,t.jsxs)(n.p,{children:["What we see new there? ",(0,t.jsx)(n.code,{children:"bt-mz.657477.err"})," includes stderr output, ",(0,t.jsx)(n.code,{children:"bt-mz.657477.out"})," includes stdout output, and ",(0,t.jsx)(n.code,{children:"scorep_bt-mz_sum"})," includes the measurement results collected by our instrumented application."]}),"\n",(0,t.jsx)(n.p,{children:"Let's examine what is inside measurement directory:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"$ ls -1 scorep_bt-mz_sum/\nMANIFEST.md\nprofile.cubex\nscorep.cfg\n"})}),"\n",(0,t.jsxs)(n.p,{children:["The directory contains three files. ",(0,t.jsx)(n.code,{children:"MANIFEST.md"})," includes the description of metadata, ",(0,t.jsx)(n.code,{children:"profile.cubex"})," is an analysis report that was collected during the measurement, and ",(0,t.jsx)(n.code,{children:"scorep.cfg"})," is a record of measurement configuration."]}),"\n",(0,t.jsx)(n.admonition,{title:"Question",type:"tip",children:(0,t.jsxs)(n.p,{children:['Open the stdout file and find the metric "Time in seconds". Compare it to our baseline measurement ',(0,t.jsx)(n.a,{href:"/perf-analysis-hands-on/docs/baseline",children:"here"}),". Has it increased or decreased? If so, by how much? What do you think was the reason for the change?"]})})]})}function p(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(d,{...e})}):d(e)}},8453:(e,n,s)=>{s.d(n,{R:()=>i,x:()=>a});var t=s(6540);const r={},o=t.createContext(r);function i(e){const n=t.useContext(o);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:i(e.components),t.createElement(o.Provider,{value:n},e.children)}}}]);